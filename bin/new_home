#!/bin/sh

print_usage() {
	echo "Usage $0 -h hostname [-d] [-x]"
	echo "    -d signals Dropbox is to be used"
	echo "    -x signals Xorg is to be included"
}

while getopts dxh: o
do
	case "$o" in
		d) 
			dropbox=1 ;;
		x)
			xorg=1 ;;
		h)
			host=$OPTARG ;;
		[?]) 
			print_usage
			exit 1
	esac
done

if test -z $host; then
	print_usage
	exit 1
fi

mkdir $host
cd $host
git init .

mkdir .local
cd .local
echo "share" >> .gitignore
cd ..

# add common submodules
if test $dropbox; then
	ln -s Dropbox/.common .common
else
	mkdir .common
	git submodule add sigil.org:/export/git/home_base .common/base
fi

# symlinks
ln -s .common/dotfiles/misc/ackrc .ackrc

ln -s .common/dotfiles/vimfiles .vim
ln -s .common/dotfiles/vimfiles/vimrc .vimrc

ln -s .common/dotfiles/sh/aliasrc .aliasrc
ln -s .common/dotfiles/sh/zlogin .zlogin
ln -s .common/dotfiles/sh/zshrc .zshrc
ln -s .common/dotfiles/misc/bcrc .bcrc
ln -s .common/dotfiles/misc/tmux.conf .tmux.conf

# ssh
mkdir .ssh
cd .ssh
ln -s ../.common/dotfiles/misc/ssh/authorized_keys .
ln -s ../.common/dotfiles/misc/ssh/config .
ln -s ../.common/dotfiles/misc/ssh/known_hosts .
cd ..

ln -s .common/dotfiles/misc/ttytterrc .ttytterrc
ln -s .common/dotfiles/misc/irssi .irssi
ln -s .common/dotfiles/misc/git/gitignore gitignore
ln -s .common/dotfiles/misc/git/gitconfig .gitconfig

if test $xorg; then

	git submodule add sigil.org:/export/git/home_X .common/X
	ln -s .common/X/Xdefaults .Xdefaults
	ln -s .common/X/gtk-bookmarks .gtk-bookmarks
	ln -s .common/X/gtkrc-1.2-gnome2 .gtkrc-1.2-gnome2
	ln -s .common/X/gtkrc-2.0 .gtkrc-2.0
	ln -s .common/X/icons .icons

fi

echo ".cache" >> .gitignore
echo ".histfile" >> .gitignore
echo ".keychain" >> .gitignore
echo ".lesshst" >> .gitignore
echo ".viminfo" >> .gitignore
echo ".yankring_history_v2.txt" >> .gitignore
echo ".zcompdump" >> .gitignore

find . -type d -exec chmod 755 {} \;

git add .
git commit -m"initial commit for $host"
git remote add origin ssh://sigil.org:4242/export/git/homes/$host

echo "ssh into omni0"
echo "Run: mkdir /export/git/homes/$host && cd /export/git/homes/$host && git init --bare"
echo "then 'git push origin master' from here"

# TODO: include Dropbox daemon?
# TODO: create tarball
# TODO: auto-generate ssh key?
# TODO: awesome
